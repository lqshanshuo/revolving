<!DOCTYPE html>
<html lang="en">

  <head>

    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="The prototype website of web framework">
    <meta name="author" content="LY">
    <title>Matrix</title>
    <link rel="shortcut icon" href="assets/self-owned/ico/favicon.png">
    <link rel="shortcut icon" href="assets/self-owned/ico/favicon.png">
    <link rel="stylesheet" type="text/css" href="assets/reference/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="assets/reference/flat-ui/css/flat-ui.css">
    <link rel="stylesheet" type="text/css" href="assets/reference/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="assets/self-owned/css/matrix.css">
    <style>
      .row > [class*="col-"] {
          margin-bottom: 0px;
      }
    </style>
  </head>

  <body>
    <div class="flat-matrix" style="background-repeat: no-repeat;background-size:100% 100%;margin-top:0px;min-height:100%">
      <!--<div class="flat-matrix" >-->
      <div class="container-fluid">
        <div id="screenDIV" class="row">
          <div class="col-sm-6">
            <video id="videoDIV" autoplay loop controls=false style="width:600px;height:100%">
              <source src="assets/self-owned/img/zgpa/tree.mp4" type="video/mp4">
            </video>
          </div>
          <div id="rightDIV" class="col-sm-6" style="background-image: url(assets/self-owned/img/zgpa/zmd1.png);background-repeat: no-repeat;background-size:100% 100%;margin-top:0px;min-height:100%;">
            <div class="col-sm-6 text-center" style="padding-top:260px;border:0px solid">
              <!-- behavior=scroll, slide, alternate -->
              <!-- direction=left,right,up,down -->
              <!-- scrollamount=20 -->
              <marquee id="mymarquee" behavior="scroll" direction="up" scrollamount=4>
                <div data-bind="foreach: revolving_list">
                  <div data-bind="if:$data">
                    <form class="form-horizontal">
                      <div class="form-group" style="margin-bottom: 0;">
                        <div class="col-sm-6" style="padding-left: 0px;">
                          <p data-bind="text: stringalpha" class="form-control-static" style="font-size: 16px;text-align: center;color:white;padding-left:0px;padding-right:0px;"></p>
                        </div>
                        <div class="col-sm-3" style="padding-left: 0px;">
                          <p data-bind="text: name" class="form-control-static" style="font-size: 16px;text-align: center;color:white;padding-left:0px;padding-right:0px;"></p>
                        </div>
                        <div class="col-sm-3" style="padding-left: 0px;">
                          <p data-bind="text: function(){return numberalpha()+'万'}(),
                            style: { color: numberalpha()>100 ?'#f6ff04':'white', fontSize:numberalpha()>=100 ? '20px':'16px',marginTop:numberalpha()>100 ? '-6px':'0px'}" class="form-control-static" style="text-align: center;padding-left:0px;padding-right:0px;"></p>
                        </div>
                      </div>
                    </form>
                  </div>
                </div>
              </marquee>
              <br>
            </div>
            <div class="col-sm-6 text-right pull-right" style="padding-top:260px;border:0px solid">
              <!-- <div><i onclick="changeScrollStatus()" class="fa fa-stop pull-right"></i></div> -->
              <div data-bind="visible: greater100_list().length !== 0">
              <div data-bind="foreach: greater100_list">
                <div class="row">
                  <div class="col-sm-5 col-sm-offset-1" data-bind="text: $data.stringalpha" style="font-weight: bold;letter-spacing: 2px; color:white;padding-left:0px;padding-right:0px;"></div>
                  <div class="col-sm-3" data-bind="text: $data.name" style="font-weight: bold;letter-spacing: 2px; color:white;padding-left:0px;padding-right:0px;"></div>
                  <div class="col-sm-3" data-bind="text: function(){return $data.numberalpha()+'万'}()" style="font-weight: bold;letter-spacing: 2px;color:#f6ff04 ;padding-left:0px;padding-right:0px;"></div>
                </div>
              </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script src="assets/reference/jquery/jquery-1.11.1.min.js"></script>
    <script src="assets/reference/jquery/jquery.json.js"></script>
    <script src="assets/reference/knockout.js/knockout-3.3.0.js"></script>
    <script src="assets/reference/jquery-tiny-pubsub/tiny-pubsub.js"></script>
    <script src="assets/self-owned/js/generic/generic_util.js"></script>

    <script language="javascript" type="text/javascript">
      var current_fetch_time = Date.now();
      $(document).ready(function () {
        // adjust page
        setInterval(function () {
          var width_video = document.body.clientWidth / 2;
          $('#videoDIV').css('width', width_video);
          $('#rightDIV').css('height', $('#videoDIV').css('height'));
        }, 1000)

        getWishes();
        setInterval(function () {
          getWishes();
        }, 1000)

//此定时器每隔一秒将 revolved_list 中的数据 push 到 revoling_list 中
        var fetch_index = 0;
        setInterval(function () {

          //第一次先将前6个push进去，之后再一个一个push到列表中
          if (fetch_index === 0) {
            for (; fetch_index < 6 && fetch_index < goalListViewModel.revolved_list().length; fetch_index++) {
              var revolve = goalListViewModel.revolved_list()[fetch_index];

              removeRepeat(revolve);

              goalListViewModel.revolving_list.push(revolve);
              if (revolve.numberalpha() >= 100) {
                goalListViewModel.greater100_list.push(revolve);
              }
            }
            return
          }

          if (fetch_index < goalListViewModel.revolved_list().length) {
            var revolve = goalListViewModel.revolved_list()[fetch_index];

            removeRepeat(revolve);

            goalListViewModel.revolving_list.push(revolve);

            if (revolve.numberalpha() >= 100) {
              goalListViewModel.greater100_list.push(revolve);
            }
            fetch_index++;
          }
        }, 1000)
      });

      function removeRepeat(revolve) {
        //遍历循环列表，判断数据是否已经存在，若更新了数据，则先移除原来的            
        for (var j = 0; j < goalListViewModel.revolving_list().length; j++) {
          var revolving = goalListViewModel.revolving_list()[j];
          if (revolving.name() === revolve.name() && revolving.stringalpha() === revolving.stringalpha() && revolving.numberalpha() !== revolve.numberalpha()) {
            goalListViewModel.revolving_list().splice(j, 1);
          }
        }
        for (var j = 0; j < goalListViewModel.greater100_list().length; j++) {
          var revolving = goalListViewModel.greater100_list()[j];
          if (revolving.name() === revolve.name() && revolving.stringalpha() === revolving.stringalpha() && revolving.numberalpha() !== revolve.numberalpha()) {
            goalListViewModel.greater100_list().splice(j, 1);
          }
        }
      }

      /**** view model start ****/
      function GoalViewModel(department, name, wish) {
        var self = this;
        self.stringalpha = ko.observable(department);
        self.name = ko.observable(name);
        self.numberalpha = ko.observable(wish);
      }

      function GoalListViewModel() {
        var self = this;

        self.original_list = ko.observableArray();
        self.revolved_list = ko.observableArray();
        self.revolving_list = ko.observableArray();
        self.greater100_list = ko.observableArray();

        self.wishList = ko.observableArray();
//        self.addWish = function (wish, origin) {
//
//        }
      }
      /**** view model end ****/

      var goalListViewModel = new GoalListViewModel();
      ko.applyBindings(goalListViewModel, document.getElementById('wishListDIV'));

      /**** server request && response handle start ****/
      var getWishes = function () {

        $.ajax({
          url: $.getServerRoot() + '/revolvinglamp/api/goal/getallgoals',
          type: 'POST',
          success: function (json) {
            goalListViewModel.original_list(json.result);
            var results = json.result;

            for (var i = 0; i < results.length; i++) {
              var need_add = true;
              var server = results[i];

              for (var j = 0; j < goalListViewModel.revolved_list().length; j++) {
                var revolve = goalListViewModel.revolved_list()[j];
                if (server.name === revolve.name() && server.stringalpha === revolve.stringalpha() && server.numberalpha !== revolve.numberalpha()) {
//                  goalListViewModel.revolved_list().splice(j, 1);
//                  goalListViewModel.revolving_list().splice(j, 1);
                  need_add = true;
                }
                if (server.name === revolve.name() && server.stringalpha === revolve.stringalpha() && server.numberalpha === revolve.numberalpha()) {
                  need_add = false;
                }
              }

              if (need_add) {
                if (server.numberbeta > current_fetch_time) {
                  var goalViewModel = new GoalViewModel(results[i].stringalpha, results[i].name, results[i].numberalpha);
                  goalListViewModel.revolved_list.push(goalViewModel);
                }
              }
            }
          },
          error: function (json) {
            console.log("error");
          }
        })
      }

      var is_scroll = true;
      var changeScrollStatus = function () {
        is_scroll = !is_scroll;
        if (is_scroll) {
          document.getElementById('mymarquee').start();
        } else {
          document.getElementById('mymarquee').stop();
                  }
                }
                

    </script>
  </body>

</html>
